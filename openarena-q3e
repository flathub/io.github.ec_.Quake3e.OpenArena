#!/bin/sh

# Set the necessary variables
if [ -z "$OA_DIR" ]; then
    OA_DIR="${XDG_DATA_HOME}"
fi

if [ -z "$OA_CVARS" ]; then
    OA_CVARS="+set fs_basegame baseoa +set fs_game oax +set protocol 71 +set fs_homepath ${OA_DIR}"
fi

if [ -z "$CONFIG_FILE" ]; then
    CONFIG_FILE="${XDG_CONFIG_HOME}/cfg"
fi

DISABLED_CVARS="+set com_protocol 72 +set cl_voip 1"
CFG_COMMENT="#----# You can change engine options by modifying these variables, or adding the variable 'CVARS', also, you can change the game engine using the variable Q3ENGINE."
RED='\033[1;31m'
NC='\033[0m' # No Color

# Determine the architecture of the system
arch="$(uname -m)"
case "$arch" in
    x86_64)
        q3e_arch="x64"
        ;;
    aarch64)
        q3e_arch="aarch64"
        ;;
esac

# Check if the configuration file exists
if [ ! -f "$CONFIG_FILE" ]; then
    # Create the configuration file with the comment
    echo "$CFG_COMMENT" > "$CONFIG_FILE"
    echo "export OA_DIR=\"$OA_DIR\"" >> "$CONFIG_FILE"
    echo "export OA_CVARS=\"$OA_CVARS\"" >> "$CONFIG_FILE"
    echo "export DISABLED_CVARS=\"$DISABLED_CVARS\"" >> "$CONFIG_FILE"
    echo -e "${RED}It seems this is your first run... There's a config file you can check out $CONFIG_FILE ${NC}"
fi
# Source the configuration file
source "$CONFIG_FILE"

# Check if the Q3ENGINE variable is set
if [ -n "$Q3ENGINE" ]; then
    # Check if the CVARS variable is set
    if [ -n "$CVARS" ]; then
        # Execute the Q3ENGINE with the provided CVARS and arguments
        exec "$Q3ENGINE" "$CVARS" "$@"
    else
        echo -e "${RED}Change the CVARS variable before starting in order to change the basegame or other game variables. To add CVARS to OA, simply add them as arguments.${NC}"
        # Execute the Q3ENGINE with the default OA_CVARS and arguments
        exec "$Q3ENGINE" "$OA_CVARS" "$@"
    fi
else
    # Check if the CVARS variable is set
    if [ -n "$CVARS" ]; then
        # Execute the quake3e binary with the provided CVARS and arguments
        exec /app/share/openarena/quake3e.${q3e_arch} "$CVARS" "$@"
    else
        # Execute the quake3e binary with the default OA_CVARS and arguments
        exec /app/share/openarena/quake3e.${q3e_arch} "$OA_CVARS" "$@"
        echo -e "${RED}Change the CVARS variable before starting in order to change the basegame. To add CVARS to OA, simply add them as arguments. You can also use the config file to do so ($CONFIG_FILE)${NC}"
    fi
fi
